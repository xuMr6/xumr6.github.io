<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        XuMr
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="XuMr" type="application/atom+xml">
</head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            celery使用+定义时间任务
        </p>
        <hr>
    </div>
    <div class="post-content">
        <p>首先说明我用的django框架,那么为什么要使用celery框架,django3.0以下版本都是同步处理请求,假设我现在有一万个任务,我的django框架是承受不了的,所以就用到了clery异步.</p>
<p><img src="https://img-blog.csdnimg.cn/20200805193534384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTQ5OTA0MA==,size_16,color_FFFFFF,t_70"></p>
<p><img src="https://img-blog.csdnimg.cn/20200805193840788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTQ5OTA0MA==,size_16,color_FFFFFF,t_70"></p>
<h3 id="首先在settings配置"><a href="#首先在settings配置" class="headerlink" title="首先在settings配置"></a>首先在settings配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步任务代理</span></span><br><span class="line">CELERY_BROKER_URL = <span class="string">&#x27;redis://127.0.0.1:6379/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务结果</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://127.0.0.1:6379/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存格式</span></span><br><span class="line">CELERY_RESULT_SERIALIZER = <span class="string">&#x27;json&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="在项目下创建一个celery-py-在里面写"><a href="#在项目下创建一个celery-py-在里面写" class="headerlink" title="在项目下创建一个celery.py     在里面写"></a>在项目下创建一个celery.py     在里面写</h3><p><img src="https://img-blog.csdnimg.cn/20200805193920805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTQ5OTA0MA==,size_16,color_FFFFFF,t_70"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;liuyue_good.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册Celery的app</span></span><br><span class="line">app = Celery(<span class="string">&#x27;liuyue_good&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定配置文件</span></span><br><span class="line">app.config_from_object(<span class="string">&#x27;django.conf:settings&#x27;</span>, namespace=<span class="string">&#x27;CELERY&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动发现各个app下的tasks.py文件</span></span><br><span class="line">app.autodiscover_tasks()</span><br></pre></td></tr></table></figure>
<h3 id="在-init中写"><a href="#在-init中写" class="headerlink" title="在__init中写"></a>在__init中写</h3><p><img src="https://img-blog.csdnimg.cn/20200805195318446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTQ5OTA0MA==,size_16,color_FFFFFF,t_70"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;liuyue_good.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册Celery的app</span></span><br><span class="line">app = Celery(<span class="string">&#x27;liuyue_good&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定配置文件</span></span><br><span class="line">app.config_from_object(<span class="string">&#x27;django.conf:settings&#x27;</span>, namespace=<span class="string">&#x27;CELERY&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动发现各个app下的tasks.py文件</span></span><br><span class="line">app.autodiscover_tasks()</span><br></pre></td></tr></table></figure>
<h3 id="在-init中写-1"><a href="#在-init中写-1" class="headerlink" title="在__init中写"></a>在__init中写</h3><p><img src="https://img-blog.csdnimg.cn/20200805195318446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTQ5OTA0MA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导包</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;celery_app&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="在views中定义函数调用celery任务"><a href="#在views中定义函数调用celery任务" class="headerlink" title="在views中定义函数调用celery任务"></a>在views中定义函数调用celery任务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> factory_test <span class="keyword">import</span> SimpleFactory</span><br><span class="line"><span class="keyword">from</span> myapp <span class="keyword">import</span> tasks</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用celery任务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">celery_test</span>(<span class="params">request</span>):</span></span><br><span class="line">    tasks.aync_test.delay()</span><br><span class="line">    SimpleFactory.ThirdLogin(<span class="string">&quot;gitee&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;task_id&#x27;</span>: <span class="string">&#x27;Hello python&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="最后启动celery"><a href="#最后启动celery" class="headerlink" title="最后启动celery"></a>最后启动celery</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># celery协程启动命令</span></span><br><span class="line">celery worker -A liuyue_good -l info -P eventlet</span><br></pre></td></tr></table></figure>
<h2 id="问题来了-怎么用celery设置一个定时任务呢"><a href="#问题来了-怎么用celery设置一个定时任务呢" class="headerlink" title="问题来了  怎么用celery设置一个定时任务呢????"></a>问题来了  怎么用celery设置一个定时任务呢????</h2><h3 id="别急这就来了"><a href="#别急这就来了" class="headerlink" title="别急这就来了"></a>别急这就来了</h3><p>在settings里配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CELERY_BEAT_SCHEDULE = &#123;</span><br><span class="line">    <span class="comment"># 定义定时任务</span></span><br><span class="line">    <span class="string">&#x27;celery_work&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;myapp.tasks.aync_test&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: timedelta(seconds=<span class="number">30</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动定时任务也要有的"><a href="#启动定时任务也要有的" class="headerlink" title="启动定时任务也要有的"></a>启动定时任务也要有的</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还要启动一个定时任务的服务</span></span><br><span class="line">celery -A liuyue_good beat -l info</span><br></pre></td></tr></table></figure>
<h3 id="这样一个完整的celery就完成了-是不是感觉有点麻烦-别急嘛-还有简单一点的"><a href="#这样一个完整的celery就完成了-是不是感觉有点麻烦-别急嘛-还有简单一点的" class="headerlink" title="这样一个完整的celery就完成了   是不是感觉有点麻烦  别急嘛  还有简单一点的"></a>这样一个完整的celery就完成了   是不是感觉有点麻烦  别急嘛  还有简单一点的</h3><h4 id="在根目录下创建一个文件夹"><a href="#在根目录下创建一个文件夹" class="headerlink" title="在根目录下创建一个文件夹"></a>在根目录下创建一个文件夹</h4><p><img src="https://img-blog.csdnimg.cn/20200805200209266.png" alt="在这里插入图片描述"></p>
<h4 id="里面配置celery"><a href="#里面配置celery" class="headerlink" title="里面配置celery"></a>里面配置celery</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;tasks&#x27;</span>, broker=<span class="string">&#x27;redis://localhost&#x27;</span>, backend=<span class="string">&#x27;redis://localhost&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task(name=&#x27;myapp.tasks.mail&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mail</span>(<span class="params">mailaddr</span>):</span></span><br><span class="line">    print(mailaddr)</span><br></pre></td></tr></table></figure>
<h3 id="怎么样是不是超简单"><a href="#怎么样是不是超简单" class="headerlink" title="怎么样是不是超简单"></a>怎么样是不是超简单</h3><h2 id="别急还没完-需要启动celery"><a href="#别急还没完-需要启动celery" class="headerlink" title="别急还没完  需要启动celery"></a>别急还没完  需要启动celery</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A tasks worker --pool=solo -l info</span><br></pre></td></tr></table></figure>
<h1 id="到这里就结束了"><a href="#到这里就结束了" class="headerlink" title="到这里就结束了"></a>到这里就结束了</h1>
    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2018-2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io"></a><a class="flink" href="https://github.com/sanjinhub/hexo-theme-geek"></a>
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>